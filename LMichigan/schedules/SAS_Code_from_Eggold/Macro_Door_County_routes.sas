%MACRO RAND;
  RANDOM=RANUNI(&SEED);
  IF RANDOM GT 1.0 THEN DO;
    PUT 'SEED TOO LARGE';
    ABORT;
  END;
%MEND RAND;

%MACRO MOORED2;
DATA HOL;
  INPUT DATE MMDDYY8. NAME $ 10-28 DUR 30;
%MEND MOORED2;

%MACRO CALENDAR;
DATA CALENDAR;    /* GENERATES DATES, MONTHS AND DAYTYPES*/
WEEK=1;
DO DATE=&SDATE TO &FDATE;
  MONTH=MONTH(DATE);
  DAY=DAY(DATE);
  WDAY=WEEKDAY(DATE);
  IF WDAY=1 THEN WEEK=WEEK+1;
  IF WDAY=1 OR WDAY=7 THEN DAYTYPE=1; ELSE DAYTYPE=2;
  IF MONTH=1 AND DAY=1 THEN DAYTYPE=1;  /*CHECKS FOR HOLIDAYS*/
  IF MONTH=5 AND 25<=DAY<=31 AND WDAY=2 THEN DAYTYPE=1;     *MEM DAY;
  IF MONTH=9 AND 1<=DAY<=7 AND WDAY=2 THEN DAYTYPE=1;     *LABOR DAY;
  IF MONTH=11 AND 22<=DAY<=28 AND WDAY=5 THEN DAYTYPE=1;      *T-DAY;
  IF MONTH=7 AND DAY=4 THEN DAYTYPE=1;
  IF DAYTYPE=1 THEN SELECT=1; ELSE SELECT=0;
  %RAND
  KEEP DATE DAYTYPE WEEK SELECT RANDOM;
  OUTPUT;
END;
PROC SUMMARY NWAY;
CLASSES WEEK;
VAR SELECT;
OUTPUT OUT=DAYS SUM=NUMBER;
DATA CALENDAR;
MERGE CALENDAR DAYS;
BY WEEK;
KEEP DATE DAYTYPE WEEK SELECT RANDOM NUMBER;
PROC SORT;
BY WEEK RANDOM;
DATA CALENDAR;  /*RANDOMLY SELECT CORRECT NUMBER OF DAYS PER WEEK*/
SET CALENDAR;
BY WEEK;
RETAIN COUNT;
IF FIRST.WEEK THEN COUNT=NUMBER;
IF SELECT=0 AND COUNT LT &NUMDAYS THEN DO;
  COUNT=COUNT+1;
  SELECT=1;
END;
KEEP DATE DAYTYPE;
IF SELECT=1;
PROC SORT;
BY DAYTYPE DATE;
PROC SUMMARY NWAY; /*SELECT ROUTES WOUT REPLACEMENT*/
CLASSES DAYTYPE;
VAR DATE;
OUTPUT OUT=NEW N=NUMBER;
DATA NEW;
SET NEW;
NUMBER=CEIL(NUMBER/&ROUTES);
SET=1;
DO I=1 TO NUMBER;
  DO ROUTE=1 TO &ROUTES;
    %RAND
    KEEP DAYTYPE SET ROUTE RANDOM;
    OUTPUT;
  END;
  SET=SET+1;
END;
PROC SORT;
BY DAYTYPE SET RANDOM;
DATA CALENDAR;
MERGE CALENDAR(IN=A) NEW(IN=B);
BY DAYTYPE;
IF A AND B;
KEEP DAYTYPE DATE ROUTE;
PROC SORT;
BY DAYTYPE ROUTE DATE;
PROC SUMMARY NWAY;     /*SELECT SHIFTS WOUT REPLACEMENT*/
CLASSES DAYTYPE ROUTE;
VAR DATE;
OUTPUT OUT=NEW N=NUMBER;
DATA NEW;
SET NEW;
NUMBER=CEIL(NUMBER/&SHIFTS);
SET=1;
DO I=1 TO NUMBER;
  DO SHIFT=1 TO &SHIFTS;
    %RAND
    KEEP DAYTYPE ROUTE SHIFT SET RANDOM;
    OUTPUT;
  END;
  SET=SET+1;
END;
PROC SORT;
BY DAYTYPE ROUTE SET RANDOM;
DATA CALENDAR;
MERGE CALENDAR(IN=A) NEW(IN=B);
BY DAYTYPE ROUTE;
IF A AND B;
KEEP DAYTYPE ROUTE SHIFT DATE;
PROC SORT;
BY DAYTYPE ROUTE SHIFT DATE;
PROC SUMMARY NWAY;     /*SELECT TRAVEL DIRECTION WOUT REPLACEMENT*/
CLASSES DAYTYPE ROUTE SHIFT;
VAR DATE;
OUTPUT OUT=NEW N=NUMBER;
DATA NEW;
SET NEW;
NUMBER=CEIL(NUMBER/2);
SET=1;
DO I=1 TO NUMBER;
  DO DIR=1 TO 2;
    %RAND
    KEEP DAYTYPE ROUTE SHIFT DIR SET RANDOM;
    OUTPUT;
  END;
  SET=SET+1;
END;
PROC SORT;
BY DAYTYPE ROUTE SHIFT SET RANDOM;
DATA CALENDAR;
MERGE CALENDAR(IN=A) NEW(IN=B);
BY DAYTYPE ROUTE SHIFT;
IF A AND B;
KEEP DAYTYPE ROUTE SHIFT DIR DATE;
PROC SORT;
BY DAYTYPE ROUTE SHIFT DIR DATE;
PROC SUMMARY NWAY;     /*SELECT START LOCATION WOUT REPLACEMENT*/
CLASSES DAYTYPE ROUTE SHIFT DIR;
VAR DATE;
OUTPUT OUT=NEW N=NUMBER;
DATA NEW;
SET NEW;
%DO X=1 %TO &ROUTES;
  IF ROUTE=&X THEN SITES=SYMGET("SITES&X");
%END;
NUMBER=CEIL(NUMBER/SITES);
SET=1;
DO I=1 TO NUMBER;
  DO LOC=1 TO SITES;
    %RAND
    KEEP DAYTYPE ROUTE SHIFT DIR LOC SET RANDOM;
    OUTPUT;
  END;
  SET=SET+1;
END;
PROC SORT;
BY DAYTYPE ROUTE SHIFT DIR SET RANDOM;
DATA CALENDAR;
MERGE CALENDAR(IN=A) NEW(IN=B);
BY DAYTYPE ROUTE SHIFT DIR;
IF A AND B;
KEEP DAYTYPE ROUTE SHIFT DIR LOC DATE;
PROC SORT;
BY DATE;

OPTIONS LINESIZE=200 PAGESIZE=80;
PROC CALENDAR DATA=CALENDAR HOLIDATA=HOL HEADER=SMALL;
FORMAT DATE MMDDYY8. ROUTE ROUTE. SHIFT SHIFT. DIR DIR.;
START DATE;
HOLISTART DATE;
HOLIVAR NAME;
HOLIDUR DUR;
ID DATE;
VAR ROUTE SHIFT DIR LOC;
%MEND CALENDAR;
